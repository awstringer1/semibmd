---
title: "Semi-parametric Benchmark Dosing with semibmd"
author: "Alex Stringer"
date: "`r Sys.Date()`"
output: github_document
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE,message=FALSE)
```

# Install the `semibmd` package

The package is hosted at https://github.com/awstringer1/semibmd. It's currently a private repo so you can't install using e.g. `remotes::install_github`. Instead, clone the repository to a local directory, say
`~/work/projects/benchmark-dose/code/semibmd` for example,
and then in `R` do:
```{r install_it}
install.packages(pkgs='~/work/projects/benchmark-dose/code/semibmd',repos=NULL,type='source')
library(semibmd)
```

# Simulate some data

Simulate some data to which the dose-response model is to be fit:
```{r simulate_data}
n <- 100
f <- function(x) 1/sqrt(x)
xmin <- .05
xmax <- .2
xcov <- seq(xmin,xmax,length.out=n)
x1 <- runif(n,xmin,xmax)
x2 <- runif(n,xmin,xmax)
set.seed(43798)
dat <- data.frame(y = rnorm(n,f(xcov)+2*x1-x2,1),x = xcov,x1=x1,x2=x2)
head(dat)
```

The exposure variable is `x` and there are two additional variables `x1` and `x2` that
can be included in the model.

# Benchmark dosing

## Fit the model

Fit the dose-response model and calculate the benchmark dose information:
```{r fitmodel}
mod <- benchmark_dose(y~s(x,bs='mpd')+x1+x2,
                      data=dat,
                      exposure = 'x',
                      x0=.05,
                      p0=.05,
                      BMR=.05,
                      monotone = TRUE)
```

The first argument to `benchmark_dose` is a formula compatible with `scam::scam` (if `monotone=TRUE`) or with `mgcv::gam` (if `monotone=FALSE`). The `scam` package accepts
formulas just like `gam`, with the addition that terms you want to be monotone should
have their bases specified manually to be one of the special monotone spline basis. See
`?scam::scam` for a list. Here I chose `bs='mpd'` for "monotone p-spline, decreasing", to
enforce a monotone-decreasing estimated curve.

If you choose `monotone = TRUE` then `scam` is used; I added the option to choose `monotone=FALSE` and fit an ordinary `gam`, based on our discussions.

The rest of the arguments are fairly self-explanatory. You have to tell it which
variable is the exposure variable (that you want the BMD(L) for) using `exposure=`. You
can look at `?benchmark_dose` for the full documentation.

## Get the summaries

Summaries and plots are obtained the usual way:
```{r summary_plot}
summary(mod)
plot(mod)
```

The `summary` method just appends the estimated BMD(L) onto the summary from the
dose-response model. The `plot` method just adds vertical lines to the plotted `scam/gam`
at the BMD and BMDL.

For more detailed access, you can get the actual fitted model using `get_model(mod)`
and the estimated BMD(L) using `get_bmd(mod)`.

